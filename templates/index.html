<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto & Forex Market Analyzer</title>
    <!-- TradingView Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #131829;
            --bg-tertiary: #1a1f3a;
            --bg-card: #1e2439;
            --bg-hover: #252b47;
            --border-color: #2d3548;
            --border-accent: #3d4563;

            --text-primary: #e4e6eb;
            --text-secondary: #a0a6b8;
            --text-muted: #6b7280;

            --accent-primary: #3b82f6;
            --accent-secondary: #8b5cf6;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;

            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 24px;
            text-align: center;
        }

        h1 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 3em;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 12px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.125rem;
            font-weight: 500;
        }

        /* Selection Panel */
        .selection-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 1.75rem;
            color: var(--text-primary);
            margin-bottom: 24px;
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        /* Tabs */
        .market-type-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            background: var(--bg-tertiary);
            padding: 6px;
            border-radius: 12px;
        }

        .market-type-tab {
            flex: 1;
            padding: 14px 24px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            border-radius: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .market-type-tab:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .market-type-tab.active {
            background: var(--gradient-primary);
            color: white;
        }

        /* Market Selection */
        .market-selection {
            display: none;
        }

        .market-selection.active {
            display: block;
        }

        .select-all-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 18px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .select-all-label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
        }

        .select-all-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }

        .selected-count {
            color: var(--accent-primary);
            font-weight: 700;
            font-size: 1.125rem;
        }

        /* Market Grid */
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .market-checkbox {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            padding: 18px 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .market-checkbox:hover {
            border-color: var(--border-accent);
            background: var(--bg-hover);
            transform: translateY(-2px);
        }

        .market-checkbox.selected {
            border-color: var(--accent-primary);
            background: rgba(59, 130, 246, 0.1);
        }

        .market-checkbox label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .market-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }

        .market-info {
            flex: 1;
        }

        .market-name {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.125rem;
            margin-bottom: 2px;
        }

        .market-symbol {
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Buttons */
        .analyze-section {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 32px;
        }

        .btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 16px 48px;
            font-size: 1.0625rem;
            font-weight: 700;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: -0.01em;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(59, 130, 246, 0.3);
        }

        .btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-primary);
            border: 2px solid var(--border-accent);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            box-shadow: none;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 60px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid var(--bg-tertiary);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            color: var(--text-secondary);
            font-size: 1.125rem;
            font-weight: 500;
        }

        #loadingProgress {
            color: var(--text-primary);
            font-weight: 600;
            margin-top: 8px;
        }

        /* Results Section */
        .results-section {
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .results-header {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 24px 32px;
            border-radius: 16px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-title {
            font-size: 1.75rem;
            color: var(--text-primary);
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        /* Results Tabs */
        .results-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .results-tab {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 18px 24px;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            font-weight: 700;
            font-size: 1.0625rem;
            color: var(--text-secondary);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .results-tab:hover {
            background: var(--bg-hover);
            border-color: var(--border-accent);
            transform: translateY(-2px);
        }

        .results-tab.active {
            background: var(--gradient-primary);
            color: white;
            border-color: transparent;
        }

        .results-content {
            display: none;
        }

        .results-content.active {
            display: block;
        }

        /* Market Cards */
        .market-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .market-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 28px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .market-card:hover {
            transform: translateY(-4px);
            border-color: var(--border-accent);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .market-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-market-name {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -0.01em;
        }

        .card-market-symbol {
            color: var(--text-muted);
            font-size: 0.9375rem;
            font-weight: 600;
            margin-top: 4px;
        }

        .price-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .price {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .change {
            font-size: 1.125rem;
            font-weight: 700;
            padding: 8px 16px;
            border-radius: 8px;
        }

        .change.positive {
            color: var(--accent-success);
            background: rgba(16, 185, 129, 0.15);
        }

        .change.negative {
            color: var(--accent-danger);
            background: rgba(239, 68, 68, 0.15);
        }

        /* Signal Badge */
        .signal {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 800;
            font-size: 1.0625rem;
            margin-bottom: 20px;
            width: 100%;
            text-align: center;
            letter-spacing: 0.025em;
            text-transform: uppercase;
        }

        .signal.STRONG_BUY {
            background: var(--gradient-success);
            color: white;
        }

        .signal.BUY {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-success);
            border: 2px solid var(--accent-success);
        }

        .signal.HOLD {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-warning);
            border: 2px solid var(--accent-warning);
        }

        .signal.SELL {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-danger);
            border: 2px solid var(--accent-danger);
        }

        .signal.STRONG_SELL {
            background: var(--gradient-danger);
            color: white;
        }

        /* Strength Bar */
        .strength-bar {
            background: var(--bg-tertiary);
            border-radius: 10px;
            height: 24px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .strength-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.875rem;
            font-weight: 700;
        }

        /* Reasons */
        .reasons {
            margin-top: 20px;
        }

        .reasons-title {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 1.0625rem;
        }

        .reason {
            padding: 10px 14px;
            margin: 8px 0;
            background: var(--bg-tertiary);
            border-left: 3px solid var(--accent-primary);
            border-radius: 8px;
            font-size: 0.9375rem;
            color: var(--text-secondary);
        }

        /* Candlestick Patterns */
        .candle-patterns {
            margin-top: 20px;
            padding: 18px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 1px solid var(--border-accent);
        }

        .candle-patterns-title {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 1.0625rem;
        }

        .pattern {
            padding: 12px 14px;
            margin: 8px 0;
            background: var(--bg-card);
            border-left: 3px solid var(--accent-primary);
            border-radius: 8px;
            font-size: 0.9375rem;
        }

        .pattern-name {
            font-weight: 700;
            color: var(--accent-primary);
        }

        .pattern-bullish {
            border-left-color: var(--accent-success);
        }

        .pattern-bullish .pattern-name {
            color: var(--accent-success);
        }

        .pattern-bearish {
            border-left-color: var(--accent-danger);
        }

        .pattern-bearish .pattern-name {
            color: var(--accent-danger);
        }

        /* Entry/Exit Section */
        .entry-exit {
            margin-top: 20px;
            padding: 18px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .entry-exit-title {
            font-weight: 700;
            color: var(--accent-warning);
            margin-bottom: 14px;
            font-size: 1.0625rem;
        }

        .trade-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 14px;
        }

        .trade-item {
            background: var(--bg-card);
            padding: 14px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .trade-label {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-bottom: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .trade-value {
            font-weight: 800;
            font-size: 1.125rem;
            color: var(--text-primary);
        }

        .trade-type {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 800;
            margin-bottom: 12px;
            width: 100%;
            text-align: center;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .trade-type.LONG {
            background: var(--gradient-success);
            color: white;
        }

        .trade-type.SHORT {
            background: var(--gradient-danger);
            color: white;
        }

        .trade-type.NO_TRADE {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            border: 1px solid var(--border-color);
        }

        /* Disclaimer */
        .disclaimer {
            background: var(--bg-secondary);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 24px;
            margin-top: 32px;
            text-align: center;
        }

        .disclaimer strong {
            color: var(--accent-warning);
            font-size: 1.125rem;
            font-weight: 800;
        }

        .disclaimer p {
            color: var(--text-secondary);
            margin-top: 8px;
            line-height: 1.6;
        }

        /* No Results */
        .no-results {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            color: var(--text-muted);
            font-size: 1.125rem;
            font-weight: 600;
        }

        /* Error */
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--accent-danger);
            border-radius: 12px;
            padding: 24px;
            margin: 24px 0;
            color: var(--accent-danger);
            text-align: center;
            font-weight: 600;
        }

        /* Chart Container */
        .chart-container {
            margin-top: 20px;
            margin-bottom: 20px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }

        .chart-title {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 1.0625rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-timeframe {
            font-size: 0.8125rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .chart-wrapper {
            border-radius: 8px;
            overflow: hidden;
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            .market-cards-grid {
                grid-template-columns: 1fr;
            }

            .market-grid {
                grid-template-columns: 1fr;
            }

            .analyze-section {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Crypto & Forex Market Analyzer</h1>
            <p class="subtitle">Professional Technical Analysis with 40+ Indicators</p>
        </header>

        <!-- Market Selection Panel -->
        <div class="selection-panel" id="selectionPanel">
            <h2 class="section-title">Select Markets to Analyze</h2>

            <div class="market-type-tabs">
                <button class="market-type-tab active" onclick="switchMarketType('crypto')">
                    Cryptocurrencies
                </button>
                <button class="market-type-tab" onclick="switchMarketType('forex')">
                    Forex Pairs
                </button>
            </div>

            <!-- Crypto Selection -->
            <div id="crypto-selection" class="market-selection active">
                <div class="select-all-section">
                    <label class="select-all-label">
                        <input type="checkbox" id="selectAllCrypto" onchange="toggleSelectAll('crypto')">
                        Select All Cryptocurrencies
                    </label>
                    <span class="selected-count" id="cryptoCount">0 selected</span>
                </div>
                <div class="market-grid" id="cryptoGrid">
                    <!-- Crypto markets will be loaded here -->
                </div>
            </div>

            <!-- Forex Selection -->
            <div id="forex-selection" class="market-selection">
                <div class="select-all-section">
                    <label class="select-all-label">
                        <input type="checkbox" id="selectAllForex" onchange="toggleSelectAll('forex')">
                        Select All Forex Pairs
                    </label>
                    <span class="selected-count" id="forexCount">0 selected</span>
                </div>
                <div class="market-grid" id="forexGrid">
                    <!-- Forex markets will be loaded here -->
                </div>
            </div>

            <div class="analyze-section">
                <button class="btn" id="analyzeBtn" onclick="analyzeSelected()">
                    Analyze Selected Markets
                </button>
                <button class="btn btn-secondary" onclick="clearSelection()">
                    Clear Selection
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyzing markets with 40+ technical indicators...</p>
            <p id="loadingProgress">Preparing analysis...</p>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h2 class="results-title">Analysis Results</h2>
                <button class="btn" onclick="backToSelection()">
                    Analyze More Markets
                </button>
            </div>

            <div class="results-tabs">
                <div class="results-tab active" onclick="switchResultsTab('crypto')">
                    Cryptocurrencies
                </div>
                <div class="results-tab" onclick="switchResultsTab('forex')">
                    Forex Pairs
                </div>
            </div>

            <div id="crypto-results" class="results-content active">
                <div class="market-cards-grid" id="cryptoResultsGrid"></div>
            </div>

            <div id="forex-results" class="results-content">
                <div class="market-cards-grid" id="forexResultsGrid"></div>
            </div>
        </div>

        <div class="disclaimer">
            <strong>DISCLAIMER:</strong>
            <p>This tool is for educational and informational purposes only. It does NOT constitute financial advice. Trading cryptocurrencies and forex carries substantial risk of loss. Always do your own research and consult with licensed financial advisors before making investment decisions.</p>
        </div>
    </div>

    <script>
        let availableMarkets = { crypto: [], forex: [] };
        let selectedMarkets = { crypto: new Set(), forex: new Set() };
        let currentMarketType = 'crypto';
        let currentResultsTab = 'crypto';

        // Load available markets on page load
        window.addEventListener('DOMContentLoaded', loadMarkets);

        async function loadMarkets() {
            try {
                const response = await fetch('/api/markets');
                const data = await response.json();

                if (data.success) {
                    availableMarkets = data.data;
                    renderMarketGrid('crypto');
                    renderMarketGrid('forex');
                }
            } catch (error) {
                console.error('Error loading markets:', error);
            }
        }

        function renderMarketGrid(type) {
            const grid = document.getElementById(`${type}Grid`);
            grid.innerHTML = '';

            availableMarkets[type].forEach(market => {
                const div = document.createElement('div');
                div.className = 'market-checkbox';
                div.id = `market-${type}-${market.symbol.replace(/[^a-zA-Z0-9]/g, '')}`;

                div.innerHTML = `
                    <label>
                        <input type="checkbox" value="${market.symbol}" onchange="toggleMarket('${type}', '${market.symbol}')">
                        <div class="market-info">
                            <div class="market-name">${market.name}</div>
                            <div class="market-symbol">${market.symbol}</div>
                        </div>
                    </label>
                `;

                grid.appendChild(div);
            });
        }

        function switchMarketType(type) {
            currentMarketType = type;

            // Update tabs
            document.querySelectorAll('.market-type-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.market-selection').forEach(selection => {
                selection.classList.remove('active');
            });
            document.getElementById(`${type}-selection`).classList.add('active');
        }

        function toggleMarket(type, symbol) {
            if (selectedMarkets[type].has(symbol)) {
                selectedMarkets[type].delete(symbol);
            } else {
                selectedMarkets[type].add(symbol);
            }

            updateSelectedCount(type);
            updateMarketCardStyle(type, symbol);
            updateSelectAllCheckbox(type);
        }

        function updateMarketCardStyle(type, symbol) {
            const card = document.getElementById(`market-${type}-${symbol.replace(/[^a-zA-Z0-9]/g, '')}`);
            if (selectedMarkets[type].has(symbol)) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        }

        function toggleSelectAll(type) {
            const checkbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const checkboxes = document.querySelectorAll(`#${type}Grid input[type="checkbox"]`);

            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
                const symbol = cb.value;

                if (checkbox.checked) {
                    selectedMarkets[type].add(symbol);
                } else {
                    selectedMarkets[type].delete(symbol);
                }
                updateMarketCardStyle(type, symbol);
            });

            updateSelectedCount(type);
        }

        function updateSelectAllCheckbox(type) {
            const selectAllCheckbox = document.getElementById(`selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
            const totalMarkets = availableMarkets[type].length;
            const selectedCount = selectedMarkets[type].size;

            selectAllCheckbox.checked = selectedCount === totalMarkets && totalMarkets > 0;
        }

        function updateSelectedCount(type) {
            const count = selectedMarkets[type].size;
            document.getElementById(`${type}Count`).textContent = `${count} selected`;
        }

        function clearSelection() {
            ['crypto', 'forex'].forEach(type => {
                selectedMarkets[type].clear();
                document.querySelectorAll(`#${type}Grid input[type="checkbox"]`).forEach(cb => {
                    cb.checked = false;
                });
                document.querySelectorAll(`#${type}Grid .market-checkbox`).forEach(card => {
                    card.classList.remove('selected');
                });
                updateSelectedCount(type);
                updateSelectAllCheckbox(type);
            });
        }

        async function analyzeSelected() {
            const totalSelected = selectedMarkets.crypto.size + selectedMarkets.forex.size;

            if (totalSelected === 0) {
                alert('Please select at least one market to analyze');
                return;
            }

            const analyzeBtn = document.getElementById('analyzeBtn');
            const loading = document.getElementById('loading');
            const selectionPanel = document.getElementById('selectionPanel');
            const resultsSection = document.getElementById('resultsSection');

            analyzeBtn.disabled = true;
            loading.classList.add('active');
            selectionPanel.style.display = 'none';
            resultsSection.classList.remove('active');

            try {
                const requestData = {
                    crypto: Array.from(selectedMarkets.crypto),
                    forex: Array.from(selectedMarkets.forex)
                };

                document.getElementById('loadingProgress').textContent =
                    `Analyzing ${totalSelected} market${totalSelected > 1 ? 's' : ''}...`;

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const data = await response.json();

                if (data.success) {
                    displayResults(data.data);
                    resultsSection.classList.add('active');
                } else {
                    alert('Error: ' + data.error);
                    selectionPanel.style.display = 'block';
                }
            } catch (error) {
                alert('Failed to analyze markets: ' + error.message);
                selectionPanel.style.display = 'block';
            } finally {
                analyzeBtn.disabled = false;
                loading.classList.remove('active');
            }
        }

        function displayResults(data) {
            displayMarketResults(data.crypto, 'cryptoResultsGrid');
            displayMarketResults(data.forex, 'forexResultsGrid');
        }

        function displayMarketResults(markets, gridId) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';

            if (!markets || markets.length === 0) {
                grid.innerHTML = '<div class="no-results">No results to display</div>';
                return;
            }

            markets.forEach(market => {
                const card = createMarketCard(market);
                grid.appendChild(card);
            });
        }

        let chartCounter = 0; // Global chart counter for unique IDs

        function createMarketCard(market) {
            const card = document.createElement('div');
            card.className = 'market-card';

            const changeClass = market.change_24h >= 0 ? 'positive' : 'negative';
            const changeSign = market.change_24h >= 0 ? '+' : '';
            const signalClass = market.signal.replace(' ', '_');
            const chartId = `chart-${chartCounter++}`;

            // Generate 5-minute candlestick patterns HTML (short-term/scalping)
            let patterns5mHTML = '';
            if (market.candle_patterns_5m && market.candle_patterns_5m.length > 0) {
                patterns5mHTML = `
                    <div class="candle-patterns" style="border-color: rgba(245, 158, 11, 0.3);">
                        <div class="candle-patterns-title" style="color: ${getComputedStyle(document.documentElement).getPropertyValue('--accent-warning')};">⚡ 5-Minute Patterns (Scalping/Day Trading)</div>
                        ${market.candle_patterns_5m.map(pattern => `
                            <div class="pattern pattern-${pattern.type}">
                                <span class="pattern-name">${pattern.name}</span>
                                <span style="float: right; color: var(--text-muted);">Strength: ${pattern.strength}/10</span>
                                <div style="clear: both; margin-top: 5px; font-size: 0.875rem; color: var(--text-secondary);">
                                    ${pattern.description}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Generate 4-hour candlestick patterns HTML (medium-term/swing trading)
            let patterns4hHTML = '';
            if (market.candle_patterns_4h && market.candle_patterns_4h.length > 0) {
                patterns4hHTML = `
                    <div class="candle-patterns">
                        <div class="candle-patterns-title">📊 4-Hour Patterns (Swing Trading)</div>
                        ${market.candle_patterns_4h.map(pattern => `
                            <div class="pattern pattern-${pattern.type}">
                                <span class="pattern-name">${pattern.name}</span>
                                <span style="float: right; color: var(--text-muted);">Strength: ${pattern.strength}/10</span>
                                <div style="clear: both; margin-top: 5px; font-size: 0.875rem; color: var(--text-secondary);">
                                    ${pattern.description}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // For backward compatibility, also check old key
            if (!patterns4hHTML && market.candle_patterns && market.candle_patterns.length > 0) {
                patterns4hHTML = `
                    <div class="candle-patterns">
                        <div class="candle-patterns-title">📊 4-Hour Patterns (Swing Trading)</div>
                        ${market.candle_patterns.map(pattern => `
                            <div class="pattern pattern-${pattern.type}">
                                <span class="pattern-name">${pattern.name}</span>
                                <span style="float: right; color: var(--text-muted);">Strength: ${pattern.strength}/10</span>
                                <div style="clear: both; margin-top: 5px; font-size: 0.875rem; color: var(--text-secondary);">
                                    ${pattern.description}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Generate entry/exit HTML
            let entryExitHTML = '';
            if (market.entry_exit && market.entry_exit.trade_type !== 'NO TRADE') {
                const ee = market.entry_exit;
                entryExitHTML = `
                    <div class="entry-exit">
                        <div class="entry-exit-title">💰 Trading Setup</div>
                        <div class="trade-type ${ee.trade_type.replace(' ', '_')}">
                            ${ee.trade_type}
                        </div>
                        <div style="font-size: 0.9375rem; color: var(--text-secondary); margin-bottom: 12px;">
                            ${ee.recommendation}
                        </div>
                        ${ee.stop_loss_reasoning ? `
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 8px; padding: 10px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-color);">
                            <strong style="color: var(--text-primary);">Stop Loss:</strong> ${ee.stop_loss_reasoning}
                        </div>
                        ` : ''}
                        ${ee.take_profit_reasoning ? `
                        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 12px; padding: 10px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-color);">
                            <strong style="color: var(--text-primary);">Take Profit:</strong> ${ee.take_profit_reasoning}
                        </div>
                        ` : ''}
                        <div class="trade-info">
                            <div class="trade-item">
                                <div class="trade-label">Entry Price</div>
                                <div class="trade-value">$${ee.entry_price}</div>
                            </div>
                            <div class="trade-item">
                                <div class="trade-label">Stop Loss</div>
                                <div class="trade-value" style="color: var(--accent-danger);">$${ee.stop_loss}</div>
                            </div>
                            <div class="trade-item">
                                <div class="trade-label">Take Profit</div>
                                <div class="trade-value" style="color: var(--accent-success);">$${ee.take_profit}</div>
                            </div>
                            <div class="trade-item">
                                <div class="trade-label">Risk/Reward</div>
                                <div class="trade-value">1:${ee.risk_reward_ratio}</div>
                            </div>
                            <div class="trade-item">
                                <div class="trade-label">Risk Amount</div>
                                <div class="trade-value">${ee.risk_percent}%</div>
                            </div>
                            <div class="trade-item">
                                <div class="trade-label">Potential Profit</div>
                                <div class="trade-value" style="color: var(--accent-success);">+${ee.potential_profit_percent}%</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="market-header">
                    <div>
                        <div class="card-market-name">${market.name || market.symbol}</div>
                        <div class="card-market-symbol">${market.symbol}</div>
                    </div>
                </div>

                <div class="price-info">
                    <div class="price">$${market.current_price ? market.current_price.toFixed(2) : 'N/A'}</div>
                    <div class="change ${changeClass}">
                        ${market.change_24h ? changeSign + market.change_24h.toFixed(2) + '%' : 'N/A'}
                    </div>
                </div>

                <div class="signal ${signalClass}">
                    ${market.signal}
                </div>

                <div class="strength-bar">
                    <div class="strength-fill" style="width: ${market.strength}%">
                        ${market.strength.toFixed(1)}%
                    </div>
                </div>

                ${market.chart_data && market.chart_data.length > 0 ? `
                <div class="chart-container">
                    <div class="chart-title">
                        <span>📈 Price Chart</span>
                        <span class="chart-timeframe">1 Hour</span>
                    </div>
                    <div class="chart-wrapper">
                        <div id="${chartId}" style="width: 100%; height: 300px;"></div>
                    </div>
                </div>
                ` : ''}

                <div class="reasons">
                    <div class="reasons-title">Analysis Factors:</div>
                    ${market.reasons.slice(0, 5).map(reason =>
                        `<div class="reason">${reason}</div>`
                    ).join('')}
                </div>

                ${patterns5mHTML}
                ${patterns4hHTML}
                ${entryExitHTML}
            `;

            // Render chart if data is available
            if (market.chart_data && market.chart_data.length > 0) {
                setTimeout(() => renderChart(chartId, market), 100);
            }

            return card;
        }

        function renderChart(chartId, market) {
            const container = document.getElementById(chartId);
            if (!container) return;

            // Create chart
            const chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: 300,
                layout: {
                    background: { color: '#1a1f3a' },
                    textColor: '#a0a6b8',
                },
                grid: {
                    vertLines: { color: '#2d3548' },
                    horzLines: { color: '#2d3548' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#2d3548',
                },
                timeScale: {
                    borderColor: '#2d3548',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });

            // Add candlestick series
            const candleSeries = chart.addCandlestickSeries({
                upColor: '#10b981',
                downColor: '#ef4444',
                borderUpColor: '#10b981',
                borderDownColor: '#ef4444',
                wickUpColor: '#10b981',
                wickDownColor: '#ef4444',
            });

            // Set chart data
            candleSeries.setData(market.chart_data);

            // Add volume series
            const volumeSeries = chart.addHistogramSeries({
                color: '#3b82f6',
                priceFormat: {
                    type: 'volume',
                },
                priceScaleId: '',
                scaleMargins: {
                    top: 0.8,
                    bottom: 0,
                },
            });

            // Set volume data
            const volumeData = market.chart_data.map(d => ({
                time: d.time,
                value: d.volume,
                color: d.close >= d.open ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)'
            }));
            volumeSeries.setData(volumeData);

            // Add moving averages if available
            if (market.indicators) {
                // SMA 20 (short-term)
                if (market.indicators.sma_20) {
                    const sma20Line = chart.addLineSeries({
                        color: '#3b82f6',
                        lineWidth: 2,
                        title: 'SMA 20',
                    });
                    const sma20Data = market.chart_data.slice(-50).map((d, i) => ({
                        time: d.time,
                        value: market.indicators.sma_20
                    }));
                    sma20Line.setData([sma20Data[sma20Data.length - 1]]);
                }

                // SMA 50 (medium-term)
                if (market.indicators.sma_50) {
                    const sma50Line = chart.addLineSeries({
                        color: '#f59e0b',
                        lineWidth: 2,
                        title: 'SMA 50',
                    });
                    const sma50Data = market.chart_data.slice(-50).map((d, i) => ({
                        time: d.time,
                        value: market.indicators.sma_50
                    }));
                    sma50Line.setData([sma50Data[sma50Data.length - 1]]);
                }
            }

            // Fit content
            chart.timeScale().fitContent();

            // Handle window resize
            window.addEventListener('resize', () => {
                chart.applyOptions({ width: container.clientWidth });
            });
        }

        function switchResultsTab(tab) {
            currentResultsTab = tab;

            // Update tab buttons
            document.querySelectorAll('.results-tab').forEach(t => {
                t.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.results-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tab}-results`).classList.add('active');
        }

        function backToSelection() {
            document.getElementById('selectionPanel').style.display = 'block';
            document.getElementById('resultsSection').classList.remove('active');
        }
    </script>
</body>
</html>
